version: '0.0.0.{build}'
image: Visual Studio 2017
nuget:
  project_feed: true
  disable_publish_on_pr: true
install:
  - ps: |
      $zeroPaddedBuildNumber = [convert]::ToInt32($env:appveyor_build_number, 10).ToString("000000")
      Update-AppveyorBuild -Version "0.0.0.$zeroPaddedBuildNumber$branchstr".Replace("_", "-")
      $xmlPath = "$env:appveyor_build_folder\Vostok.AirlockConsumer\Vostok.AirlockConsumer.csproj"
      $xml = [xml](get-content $xmlPath)
      $version = $xml.CreateElement("Version")
      $versionText = $xml.CreateTextNode($env:appveyor_build_version)
      $version.AppendChild($versionText)
      $gen.ParentNode.AppendChild($version)
      $xml.Save($xmlPath)

      cd $env:appveyor_build_folder\..
      git clone https://github.com/vostok/cement.git
      cd "cement"
      nuget restore
      msbuild Cement.Net.sln

      $cm="$env:appveyor_build_folder\..\cement\Cement.Net\bin\Release\cm.exe"
      cd $env:appveyor_build_folder\..
      & $cm init

      $wc = New-Object System.Net.WebClient
      $wc.DownloadFile("https://raw.githubusercontent.com/vostok/cement-modules/master/settings", "$env:USERPROFILE\.cement\settings")

      cd $env:appveyor_build_folder
      echo update-deps
      & $cm update-deps
      echo build-deps
      & $cm build-deps
      echo dotnet restore
      dotnet restore
configuration: Release
after_build:
  - ps: if ($env:appveyor_repo_branch -eq "master") { Get-ChildItem $env:appveyor_build_folder\Vostok.AirlockConsumer\bin\Release\Vostok.AirlockConsumer.*.nupkg | % { Push-AppveyorArtifact $_.FullName -FileName $_.Name } }
test_script:
  - ps: |
      dotnet test "$env:appveyor_build_folder\Vostok.AirlockConsumer.UnitTests\Vostok.AirlockConsumer.UnitTests.csproj" --logger "trx;LogFileName=airlock-consumer-tests.trx"
after_test:
  - ps: |
      $wc = New-Object 'System.Net.WebClient'
      $wc.UploadFile("https://ci.appveyor.com/api/testresults/mstest/$($env:appveyor_job_id)", "$env:appveyor_build_folder\Vostok.AirlockConsumer.UnitTests\TestResults\airlock-consumer-tests.trx")
